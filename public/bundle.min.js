import qe from"../node_modules/dotenv/lib/main.js";import Pe from"../node_modules/express/index.js";import je from"../node_modules/cors/lib/index.js";import be from"../node_modules/body-parser/index.js";import xe from"../node_modules/mongoose/index.js";import fe from"../node_modules/jsonwebtoken/index.js";var j=(o=>(o[o.INTERNAL_SERVER_ERROR=1e3]="INTERNAL_SERVER_ERROR",o[o.TOKEN_NOT_DEFINED=1100]="TOKEN_NOT_DEFINED",o[o.TOKEN_EXPIRED=1101]="TOKEN_EXPIRED",o[o.INVALID_TOKEN=1102]="INVALID_TOKEN",o[o.UNAUTHORIZED=1103]="UNAUTHORIZED",o[o.NO_PERMISSION=1104]="NO_PERMISSION",o[o.INVALID_PASSWORD=1105]="INVALID_PASSWORD",o[o.INVALID_CREDENTIALS=1106]="INVALID_CREDENTIALS",o[o.SESSION_EXPIRED=1107]="SESSION_EXPIRED",o[o.SESSION_UNAVAILABLE=1108]="SESSION_UNAVAILABLE",o[o.FIELD_REQUIRED=1200]="FIELD_REQUIRED",o[o.INVALID_FIELD_FORMAT=1201]="INVALID_FIELD_FORMAT",o[o.MISSING_PARAMETER=1202]="MISSING_PARAMETER",o[o.INVALID_INPUT=1203]="INVALID_INPUT",o[o.TOO_MANY_REQUESTS=1204]="TOO_MANY_REQUESTS",o[o.RESOURCE_NOT_FOUND=1300]="RESOURCE_NOT_FOUND",o[o.RESOURCE_ALREADY_EXISTS=1301]="RESOURCE_ALREADY_EXISTS",o[o.ENV_VARIABLE_NOT_DEFINED=1400]="ENV_VARIABLE_NOT_DEFINED",o[o.MISSING_DATABASE_URL=1401]="MISSING_DATABASE_URL",o[o.MISSING_JWT_SECRET=1402]="MISSING_JWT_SECRET",o[o.EXTERNAL_API_ERROR=1500]="EXTERNAL_API_ERROR",o[o.EXTERNAL_API_UNAUTHORIZED=1501]="EXTERNAL_API_UNAUTHORIZED",o[o.MONGO_ERROR=1600]="MONGO_ERROR",o))(j||{}),c=j;var b=[],x=t=>{t&&b.push(t)},y=(t,e,s)=>{let r=t.headers.authorization?.split(" ")[1];if(!r)return e.status(401).json({error:!0,type:"unauthorized",message:"Please log in."});if(b.includes(r))return e.status(401).json({error:!0,type:"token_blacklisted"});if(!process.env.JWT_SECRET)return e.status(500).json({error:!0,type:"server_error",code:c.ENV_VARIABLE_NOT_DEFINED});fe.verify(r,process.env.JWT_SECRET,(n,a)=>{if(n)return n.name==="TokenExpiredError"?e.status(401).json({error:!0,type:"token_expired"}):e.status(401).json({error:!0,type:"invalid_token"});if(!a||typeof a!="object"||!("username"in a))return e.status(401).json({error:!0,type:"invalid_token"});t.user=a.username,s()})};import{body as S}from"../node_modules/express-validator/lib/index.js";var M=[S("name").isLength({min:6,max:50}).custom(t=>{if(!t)throw new Error("name_required");return!0}),S("username").isLength({min:6,max:30}).custom(t=>{if(!t)throw new Error("username_required");return!0}),S("email").isEmail().custom(t=>{if(!t)throw new Error("email_required");return!0}).normalizeEmail(),S("password").custom(t=>{let e=[];if(t?(t.length<8&&e.push("password_too_short"),/[a-z]/.test(t)||e.push("password_no_lowercase"),/[A-Z]/.test(t)||e.push("password_no_uppercase"),/[0-9]/.test(t)||e.push("password_no_number"),/[\W_]/.test(t)||e.push("password_no_special")):e.push("password_required"),e.length)throw new Error(e.join(","));return!0})];import we from"../node_modules/jsonwebtoken/index.js";import k from"../node_modules/mongoose/index.js";var ye=new k.Schema({username:{type:String,required:!0,unique:!0},lastActivity:{type:Date,required:!0},token:{type:String}}),ge=k.model("Session",ye),g=ge;import h from"../node_modules/winston/lib/winston.js";var Re=h.createLogger({level:"info",format:h.format.combine(h.format.colorize(),h.format.simple()),transports:[new h.transports.Console]}),i=Re;var w=async(t,e,s)=>{let r=t.headers.authorization?.split(" ")[1];if(!r)return e.status(401).json({errror:!0,type:"unauthorized",code:c.MISSING_JWT_SECRET});if(!process.env.JWT_SECRET)return e.status(401).json({errror:!0,type:"unauthorized",code:c.ENV_VARIABLE_NOT_DEFINED});let n={error:!0,type:"server_error"};try{let p=we.verify(r,process.env.JWT_SECRET).username,d=await g.findOne({username:p});if(!d)return e.status(401).json({...n,code:c.SESSION_UNAVAILABLE});let l=new Date,m=24*60*60*1e3;if(l.getTime()-d.lastActivity.getTime()>m)return await g.deleteOne({username:p}),e.status(401).json({...n,code:c.SESSION_EXPIRED});d.lastActivity=l,await d.save(),s()}catch(a){return i.error(a),e.status(401).json({errorRes:n,code:c.INTERNAL_SERVER_ERROR})}};import L from"../node_modules/mongoose/index.js";var U=new L.Schema({indexSymbol:{type:String,required:!0,trim:!0},current:{type:Number,required:!0},percentChange:{type:Number,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});U.pre("save",function(t){this.updatedAt=new Date,t()});var _e=L.model("Index",U,"indices"),O=_e;var B=async(t,e)=>{let s=["NIFTY 50","NIFTY BANK"];try{let r=await O.find({indexSymbol:{$in:s}}).lean().select("-_id -__v -createdAt -updatedAt");e.status(200).json(r)}catch(r){r instanceof Error&&e.status(500).json({error:r.message})}},V=async(t,e)=>{let s=t.body;try{await Promise.all(s.map(async r=>{await O.updateOne({indexSymbol:r.indexSymbol},{$set:{current:r.current,percentChange:r.percentChange,updatedAt:Date.now()},$setOnInsert:{createdAt:Date.now()}},{upsert:!0})})),e.status(200).json({message:"Indices data saved successfully!"})}catch(r){let n="Error saving indices data";return r instanceof Error&&(n+=r.message),i.error(n),e.status(500).json({message:"Error saving indices data"})}};import G from"../node_modules/mongoose/index.js";var $=new G.Schema({symbol:{type:String,required:!0,trim:!0},lastPrice:{type:Number,required:!0},change:{type:Number,required:!0},pChange:{type:Number,required:!0},previousClose:{type:Number,required:!0},open:{type:Number,required:!0},close:{type:Number,required:!0},basePrice:{type:Number,required:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});$.pre("save",function(t){this.updatedAt=new Date,t()});var he=G.model("MarketData",$,"marketdata"),N=he;var W=async(t,e)=>{let s=t.body;try{await Promise.all(s.map(async r=>{await N.updateOne({symbol:r.symbol},{$set:{lastPrice:r.lastPrice,change:r.change,pChange:r.pChange,previousClose:r.previousClose,open:r.open,close:r.close,basePrice:r.basePrice,updatedAt:Date.now()},$setOnInsert:{createdAt:Date.now()}},{upsert:!0})})),e.status(200).json({message:"Data saved successfully!"})}catch(r){return e.status(500).json({message:"Error saving data",error:r})}};var F=async(t,e)=>{try{let s=await N.find({}).lean().select("-_id -__v -createdAt"),r=s.reduce((n,a)=>new Date(a.updatedAt)<new Date(n.updatedAt)?a:n);e.status(200).json({market:s,updatedAt:r.updatedAt})}catch(s){e.status(500).json({message:"Error retrieving market data",error:s})}};import q from"../node_modules/mongoose/index.js";var De=new q.Schema({dateAdded:{type:Date,required:!0,get:t=>new Date(t)},quantity:{type:Number,required:!0},avgPrice:{type:Number,required:!0},exchange:{type:String,required:!0,trim:!0},isGift:{type:Boolean,required:!1},isIPO:{type:Boolean,required:!1}},{_id:!1}),H=new q.Schema({symbol:{type:String,required:!0,trim:!0},transactions:{type:[De],required:!0},userId:{type:String,required:!0,trim:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});H.pre("save",function(t){this.updatedAt=new Date,t()});var Se=q.model("Holding",H,"holdings"),_=Se;import J from"../node_modules/mongoose/index.js";var z=new J.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,trim:!0,unique:!0},username:{type:String,required:!0,unique:!0,trim:!0,minlength:6,maxlength:50},password:{type:String,required:!0,minlength:6},lastLogin:{type:Date,default:Date.now},lastActivity:{type:Date,default:Date.now},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});z.pre("save",function(t){this.updatedAt=new Date,t()});var Ie=J.model("User",z),f=Ie;var X=async(t,e)=>{try{let s=await f.findOne({username:t.user});if(!s)return e.status(500).json({error:!0,message:"Server error"});s.lastActivity=new Date,await s.save();let r=await _.find({userId:t.user}).lean().select("-_id -__v -createdAt -updatedAt -userId");if(!r)return e.status(404).json({message:"No holdings found for this user."});if(r.length===0)return e.status(200).json([]);let n=r.map(a=>({...a,transactions:a.transactions.map(p=>({...p,dateAdded:new Date(p.dateAdded).getTime()}))}));e.json(n)}catch(s){i.error(s),e.status(500).json({message:"Server error while fetching holdings",error:s})}},Y=async(t,e)=>{try{let s=await _.distinct("symbol");if(!s||s.length===0)return e.status(200).json({nse:[]});let r={nse:s};return e.json(r)}catch(s){return e.status(500).json(s)}},K=async(t,e)=>{let{symbol:s,dateAdded:r,quantity:n,avgPrice:a,exchange:p="NSE",isGift:d=!1,isIPO:l=!1}=t.body;try{let m={dateAdded:new Date(r),quantity:n,avgPrice:a,exchange:p,isGift:d,isIPO:l},R=await _.findOne({symbol:s,userId:t.user});R?R.transactions.push(m):R=new _({symbol:s,transactions:[m],userId:t.user}),await R.save(),e.status(200).send({message:`Holding ${s} added successfully!`})}catch(m){i.error(m),e.status(500).send(`Server error while adding holding, ${m}`)}},Z=async(t,e)=>{let s=t.body;if(!Array.isArray(s)||s.length===0)return e.status(400).send("Invalid data. Expected an array of holdings.");let r=s.map(n=>{let{symbol:a,dateAdded:p,quantity:d,avgPrice:l,exchange:m="NSE",isGift:R=!1,isIPO:T=!1}=n;return{updateOne:{filter:{symbol:a,userId:t.user},update:{$setOnInsert:{symbol:a,userId:t.user,createdAt:Date.now()},$push:{transactions:{dateAdded:new Date(p),quantity:d,avgPrice:l,exchange:m,isGift:R,isIPO:T}},$set:{updatedAt:Date.now()}},upsert:!0}}});try{let n=await _.bulkWrite(r);e.status(200).json({message:`Holdings uploaded successfully! Inserted: ${n.upsertedCount}, Modified: ${n.modifiedCount}`})}catch(n){i.error(n),e.status(500).send(`Server error while uploading holdings, ${n}`)}};import{MongoError as ee}from"../node_modules/mongodb/lib/index.js";import I from"../node_modules/mongoose/index.js";var Ae=new I.Schema({visibleColumns:{type:[Number],default:[]},sortColumn:{type:Number,default:1},sortOrder:{type:Number,default:1}},{_id:!1}),Q=new I.Schema({dashboard:{type:Ae}},{_id:!1}),C=new I.Schema({mobile:{type:Q},computer:{type:Q},theme:{type:Number,required:!1},userId:{type:String,required:!0,trim:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});C.pre("save",function(t){this.updatedAt=new Date,t()});var ve=I.model("Preference",C),A=ve;var te=async(t,e)=>{let s=t.user;try{let r=await f.findOne({username:s});if(!r)return e.status(404).json({error:!0,type:"user_not_found"});e.status(200).json({name:r.name})}catch(r){return i.error(r),e.status(500).json({error:!0,type:"server_error"})}},re=async(t,e)=>{let s=t.user;try{let r=await A.findOne({userId:s})?.lean().select("-_id -__v -createdAt -updatedAt -userId");if(!r)return e.status(200).json({});e.status(200).json(r)}catch(r){return i.error(r),r instanceof ee&&r.name==="CastError"?e.status(400).json({error:!0,type:"invalid_user_id"}):e.status(500).json({error:!0,type:"server_error"})}},se=async(t,e)=>{let s=t.body,r=t.user;try{let n=await A.findOne({userId:r});n?(n.set(s),n.updatedAt=new Date):n=new A({userId:r,...s,createdAt:Date.now(),updatedAt:Date.now()}),await n.save(),e.status(200).send({message:"Preferences updated successfully!"})}catch(n){if(i.error(n),n instanceof ee){if(n.name==="ValidationError")return e.status(400).json({error:!0,type:"invalid_data",code:c.MONGO_ERROR});if(n.name==="CastError")return e.status(400).json({error:!0,type:"invalid_user_id",code:c.MONGO_ERROR});if(n.code===11e3)return e.status(409).json({error:!0,type:"duplicate_preferences",code:c.MONGO_ERROR})}return e.status(500).json({error:!0,type:"server_error"})}};import{validationResult as Te}from"../node_modules/express-validator/lib/index.js";import P from"../node_modules/bcrypt/bcrypt.js";import E from"../node_modules/jsonwebtoken/index.js";import{MongoError as Oe}from"../node_modules/mongodb/lib/index.js";import Ee from"../node_modules/nodemailer/lib/nodemailer.js";var v,ne=!1,oe=()=>{process.env.GMAIL_ID&&process.env.GMAIL_PASSWORD&&(v=Ee.createTransport({service:"gmail",auth:{user:process.env.GMAIL_ID,pass:process.env.GMAIL_PASSWORD}}),v.verify(t=>{t?i.error("Error verifying transporter:",t):(ne=!0,i.info("Transporter is ready to send emails"))}))},ae=async(t,e,s)=>{if(!v||!ne)throw new Error("Transporter is not ready");let r={from:process.env.GMAIL_ID,to:t,subject:e,text:s};try{await v.sendMail(r)}catch(n){throw i.log("Error sending OTP:",n),n}};var D=[];setInterval(()=>{let t=new Date;D=D.filter(e=>e.expires>t)},60*60*1e3);var ie=async(t,e)=>{let{username:s,password:r,email:n,name:a}=t.body,p=Te(t);if(!process.env.JWT_SECRET)return e.status(500).json({error:!0,type:"server_error",code:c.ENV_VARIABLE_NOT_DEFINED});if(!p.isEmpty()){let d=p.array().flatMap(l=>l.msg.includes(",")?l.msg.split(",").map(m=>({type:m})):[{type:l.msg}]);return e.status(400).json({error:!0,type:"validation",errors:d})}try{if(await f.findOne({username:s}))return e.status(400).json({error:!0,type:"username_taken"});if(await f.findOne({email:n}))return e.status(400).json({error:!0,type:"email_taken"});let m=await P.hash(r,10);await new f({username:s,password:m,email:n,name:a}).save();let T=E.sign({username:s},process.env.JWT_SECRET,{expiresIn:"1d"});await g.findOneAndUpdate({username:s},{lastActivity:Date.now()},{upsert:!0,new:!0}),e.status(201).json({token:T,success:!0})}catch(d){if(d instanceof Oe&&d.code===11e3)return e.status(409).json({error:!0});e.status(500).json({error:!0})}},ue=async(t,e)=>{if(!process.env.JWT_SECRET)return e.status(500).json({error:!0,type:"server_error",code:c.ENV_VARIABLE_NOT_DEFINED});try{let{username:s,password:r}=t.body,n=await f.findOne({username:s});if(n&&await P.compare(r,n.password)){let a=E.sign({username:n.username},process.env.JWT_SECRET,{expiresIn:"30d"});return await g.findOneAndUpdate({username:s},{lastActivity:Date.now()},{upsert:!0,new:!0}),n.lastActivity=new Date,n.lastLogin=new Date,await n.save(),e.status(200).json({token:a})}else return e.status(401).json({error:!0,type:"invalid_credentials"})}catch(s){return i.error(s),e.status(500).send("Server error")}},pe=async(t,e)=>{try{let s=t.headers.authorization?.split(" ")[1];return await x(s),e.sendStatus(204)}catch(s){let r="Server error";return s instanceof Error&&(r+=s.message),i.error(r),e.sendStatus(401).json({error:!0,type:"server_error",code:c.INTERNAL_SERVER_ERROR})}},ce=async(t,e)=>{let{email:s}=t.body,r=Math.floor(1e5+Math.random()*9e5),n="Your Password Reset Request",a=`Use OTP ${r} to update your login credentials at MagnyFire! The OTP expires in 15 minutes.`;try{await ae(s,n,a);let p=new Date(Date.now()+15*60*1e3);return D.push({email:s,otp:r,expires:p}),e.status(200).json({success:!0})}catch{return e.status(500).json({success:!1,message:"cannot_send_otp"})}},de=async(t,e)=>{let{email:s,otp:r}=t.body,n=D.findIndex(p=>p.email===s&&p.otp===r);if(n===-1)return e.status(400).json({success:!1,message:"incorrect_otp"});if(D.splice(n,1),!process.env.JWT_SECRET)return e.status(500).json({error:!0,type:"server_error"});let a=E.sign({email:s},process.env.JWT_SECRET,{expiresIn:"15m"});return e.status(200).json({success:!0,resetToken:a})},me=async(t,e)=>{let{resetToken:s,newPassword:r}=t.body;if(!process.env.JWT_SECRET)return e.status(500).json({error:!0,type:"server_error"});try{let n=E.verify(s,process.env.JWT_SECRET),{email:a}=n,p=await P.hash(r,10);return await f.findOneAndUpdate({email:a},{password:p})?e.status(200).json({success:!0,message:"password_updated"}):e.status(404).json({success:!1,message:"user_not_found"})}catch{return e.status(400).json({success:!1,message:"invalid_or_expired_token"})}};import Ne from"../node_modules/node-cron/src/node-cron.js";Ne.schedule("0 0 * * *",async()=>{try{let t=new Date(Date.now()-864e5),e=await g.deleteMany({lastActivity:{$lt:t}});i.info(`${new Date().toISOString()} - Cleaned up ${e.deletedCount} expired sessions.`)}catch(t){i.error(`${new Date().toISOString()} - Error cleaning up expired sessions:`,t)}});qe.config();var u=Pe();u.use(je());u.use(be.json());oe();var le=process.env.PORT||4e3;process.env.MONGODB_URI?xe.connect(process.env.MONGODB_URI).then(()=>{i.info("MongoDB connected")}).catch(t=>i.error(t)):i.info("MONGODB_URI not defined in env");u.get("/userHoldingsList",Y);u.get("/api/holdings",y,w,X);u.post("/api/holdings",y,w,K);u.post("/api/upload",y,w,Z);u.post("/api/indices",V);u.get("/api/indices",y,B);u.get("/api/market",y,F);u.post("/api/market",W);u.post("/api/register",M,ie);u.post("/api/login",ue);u.post("/api/logout",pe);u.get("/api/preference",y,w,re);u.put("/api/preference",y,w,se);u.get("/api/user",y,w,te);u.post("/api/forgotPassword",ce);u.post("/api/verifyOtp",de);u.post("/api/updatePassword",me);u.listen(le,()=>{i.info(`Server is running on http://localhost:${le}`)});
